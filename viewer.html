<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIFT 3D | Products</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;800&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --brand: #74A098;
            /* Dark Defaults */
            --bg-color: #080808; 
            --glass: rgba(15, 15, 15, 0.85); 
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #fff;
            --text-sub: #aaa;
        }

        /* Light Mode Overrides */
        body.light-mode {
            --bg-color: #f4f4f4;
            --glass: rgba(255, 255, 255, 0.85);
            --border: rgba(0, 0, 0, 0.1);
            --text-main: #1a1a1a;
            --text-sub: #555;
        }

        body { margin: 0; overflow: hidden; background-color: var(--bg-color); font-family: 'Outfit', sans-serif; color: var(--text-main); overscroll-behavior: none; touch-action: none; transition: background 0.3s; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100dvh; pointer-events: none; z-index: 10; }
        
        /* LOGO */
        .logo-corner { position: absolute; top: 30px; left: 30px; display: inline-flex; flex-direction: column; line-height: 0.8; pointer-events: auto; text-decoration: none; z-index: 20; }
        .logo-shift { font-weight: 800; font-size: 2.5rem; color: var(--brand); letter-spacing: -1px; }
        .logo-3d { font-weight: 800; font-size: 2.5rem; color: var(--text-main); letter-spacing: -1px; transition: color 0.3s; }
        .logo-slogan { margin-top: 8px; font-size: 0.7rem; letter-spacing: 1.5px; color: var(--text-sub); font-weight: 400; text-transform: uppercase; border-left: 2px solid var(--brand); padding-left: 8px; }

        /* HEADER BUTTONS (Back + Theme) */
        .header-actions {
            position: absolute; top: 30px; right: 30px; z-index: 20;
            display: flex; gap: 10px; pointer-events: auto;
        }

        .action-btn {
            text-decoration: none; color: var(--text-main); font-weight: 600; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.1); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--border);
            transition: all 0.3s; backdrop-filter: blur(5px); cursor: pointer; height: 40px; box-sizing: border-box;
        }
        .action-btn:hover { background: var(--brand); color: black; border-color: var(--brand); }
        .theme-icon { font-size: 1.2rem; }

        /* Panel */
        .panel { position: absolute; top: 70%; transform: translateY(-50%); left: 40px; background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); padding: 30px; width: 320px; pointer-events: auto; border-left: 4px solid var(--brand); transition: background 0.3s, border-color 0.3s; }
        .panel h2 { margin: 0 0 5px 0; font-weight: 800; text-transform: uppercase; font-size: 2rem; color: var(--text-main); }
        .category { font-size: 0.75rem; color: var(--brand); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; display: block; }
        .spec-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding: 12px 0; font-size: 0.9rem; color: var(--text-sub); }
        .spec-val { font-weight: 500; color: var(--text-main); }

        /* Controls */
        .controls-area { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: auto; pointer-events: none; }
        .color-deck { pointer-events: auto; background: var(--glass); padding: 10px 25px; border-radius: 50px; border: 1px solid var(--border); display: flex; gap: 15px; backdrop-filter: blur(10px); }
        .swatch { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .swatch.active { border-color: var(--text-main); transform: scale(1.1); }
        
        /* Toggle */
        .toggle-container { background: rgba(125,125,125,0.1); border-radius: 5px; padding: 4px; display: flex; margin-top: 20px; position: relative; }
        .toggle-btn { flex: 1; text-align: center; padding: 10px; font-size: 0.8rem; font-weight: 600; cursor: pointer; z-index: 2; transition: color 0.3s; text-transform: uppercase; }
        .toggle-bg { position: absolute; top: 4px; left: 4px; width: 50%; height: calc(100% - 8px); background: var(--brand); border-radius: 2px; transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1); z-index: 1; }

        #progress-bar { position: absolute; top: 0; left: 0; height: 3px; background: var(--brand); width: 0%; z-index: 999; transition: width 0.2s; }

        @media (max-width: 768px) {
            .logo-corner { top: 20px; left: 20px; }
            .logo-shift, .logo-3d { font-size: 2rem; }
            .logo-slogan { font-size: 0.6rem; }
            .header-actions { top: 20px; right: 20px; }
            .action-btn { padding: 8px 15px; font-size: 0.8rem; height: 35px; }
            .panel { top: auto; left: 0; bottom: 0; transform: none; width: 100%; max-width: none; border-left: none; border-top: 4px solid var(--brand); padding: 20px 20px 100px 20px; border-radius: 20px 20px 0 0; }
            .controls-area { bottom: 20px; width: 90%; }
            .color-deck { justify-content: center; }
        }
    </style>
    
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>
    <div id="progress-bar"></div>

    <div id="ui-layer">
        <a href="index.html" class="logo-corner">
            <div class="logo-main">
                <span class="logo-shift">shift</span>
                <span class="logo-3d">3D</span>
            </div>
            <div class="logo-slogan">Additive Manufacturing Lab</div>
        </a>

        <div class="header-actions">
            <button class="action-btn" onclick="toggleTheme()" id="theme-btn">
                <span class="theme-icon">☀</span>
            </button>
            <a href="index.html" class="action-btn">Close &#10005;</a>
        </div>

        <div class="controls-area">
            <div class="color-deck">
                <div class="swatch active" style="background: #74A098;" onclick="setColor(this, 0x74A098)"></div>
                <div class="swatch" style="background: #D9D9D9;" onclick="setColor(this, 0xD9D9D9)"></div>
                <div class="swatch" style="background: #222222;" onclick="setColor(this, 0x222222)"></div>
                <div class="swatch" style="background: #C85C5C;" onclick="setColor(this, 0xC85C5C)"></div>
                <div class="swatch" style="background: #E8C060;" onclick="setColor(this, 0xE8C060)"></div>
            </div>
        </div>

        <div class="panel">
            <h2 id="prod-name">Loading...</h2>
            <span class="category" id="prod-cat">...</span>
            <div class="spec-row"><span>Material</span><span class="spec-val" id="mat-name">Standard PLA</span></div>
            <div class="spec-row"><span>Print Time</span><span class="spec-val" id="print-time">--</span></div>
            <div class="toggle-container">
                <div class="toggle-bg" id="toggle-bg"></div>
                <div class="toggle-btn" onclick="setMaterial('pla')" style="color: #000;">PLA</div>
                <div class="toggle-btn" onclick="setMaterial('plaplus')" style="color: #fff;">PLA+</div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

        // --- CONFIGURATION ---
        const catalog = {
            'benchy': { name: "3D Benchy", category: "Calibration Test", time: "1h 15m", file: "benchy.glb" },
            'hand':   { name: "Wall Hand", category: "Functional Decor", time: "5h 45m", file: "hand.glb" }
        };

        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id'); 
        const productData = catalog[productId] || catalog['benchy'];

        // Setup Scene
        const scene = new THREE.Scene(); 
        
        // --- THEME LOGIC START ---
        const themeBtn = document.getElementById('theme-btn');
        const storedTheme = localStorage.getItem('theme') || 'dark';

        function applyTheme(theme) {
            if(theme === 'light') {
                document.body.classList.add('light-mode');
                themeBtn.innerHTML = '<span class="theme-icon">☾</span>';
                scene.background = new THREE.Color(0xf4f4f4); // Light Grey 3D Background
                ambientLight.intensity = 1.0; // Brighter in light mode
            } else {
                document.body.classList.remove('light-mode');
                themeBtn.innerHTML = '<span class="theme-icon">☀</span>';
                scene.background = new THREE.Color(0x080808); // Dark 3D Background
                ambientLight.intensity = 0.8;
            }
        }
        
        // Global Toggle Function attached to Window
        window.toggleTheme = function() {
            const isLight = document.body.classList.contains('light-mode');
            const newTheme = isLight ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }
        // --- THEME LOGIC END ---

        const isMobile = window.innerWidth < 768;
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(8, isMobile ? 6 : 4, isMobile ? 15 : 10);

        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.autoRotate = true; controls.enablePan = false;
        controls.minDistance = 3; controls.maxDistance = 50;

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8); scene.add(ambientLight);
        const spotLight = new THREE.SpotLight(0xffffff, 20); spotLight.position.set(10, 20, 10); spotLight.castShadow = true; scene.add(spotLight);
        const rimLight = new THREE.PointLight(0x74A098, 10); rimLight.position.set(-5, 5, -10); scene.add(rimLight);
        
        const FLOOR_LEVEL = -2;
        const grid = new THREE.GridHelper(50, 50, 0x333333, 0x111111); grid.position.y = FLOOR_LEVEL; scene.add(grid);

        // Apply theme immediately after creating scene
        applyTheme(storedTheme);

        const baseMaterial = new THREE.MeshPhysicalMaterial({ color: 0x74A098, roughness: 0.2, metalness: 0.1, clearcoat: 0.3, clearcoatRoughness: 0.2, ior: 1.45, side: THREE.DoubleSide });

        const loader = new GLTFLoader();
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/');
        loader.setDRACOLoader(dracoLoader);

        function loadModel() {
            document.getElementById('prod-name').innerText = productData.name;
            document.getElementById('prod-cat').innerText = productData.category;
            document.getElementById('print-time').innerText = productData.time;

            loader.load(productData.file, function (gltf) {
                const mesh = gltf.scene;
                
                const box = new THREE.Box3().setFromObject(mesh);
                const size = new THREE.Vector3(); box.getSize(size);
                const maxDim = Math.max(size.x, size.y, size.z);
                if (maxDim > 0) { const s = 5.0 / maxDim; mesh.scale.set(s, s, s); }

                const newBox = new THREE.Box3().setFromObject(mesh);
                const center = new THREE.Vector3(); newBox.getCenter(center);
                mesh.position.x = -center.x; mesh.position.z = -center.z;
                const lowestPoint = newBox.min.y;
                mesh.position.y = (FLOOR_LEVEL - lowestPoint) + 0.01;

                mesh.traverse((c) => { if (c.isMesh) { c.material = baseMaterial; c.castShadow = true; c.receiveShadow = true; } });
                scene.add(mesh);
                document.getElementById('progress-bar').style.width = '0%';
            }, (xhr) => {
                if(xhr.total > 0) document.getElementById('progress-bar').style.width = (xhr.loaded / xhr.total) * 100 + '%';
            });
        }

        loadModel();

        window.setColor = function(el, hex) {
            document.querySelectorAll('.swatch').forEach(e => e.classList.remove('active')); el.classList.add('active');
            const c = new THREE.Color(hex); baseMaterial.color.set(c); rimLight.color.set(c);
        };

        window.setMaterial = function(type) {
            const bg = document.getElementById('toggle-bg'); const btns = document.querySelectorAll('.toggle-btn'); const label = document.getElementById('mat-name');
            if (type === 'pla') { bg.style.transform = 'translateX(0%)'; btns[0].style.color = '#000'; btns[1].style.color = '#fff'; baseMaterial.roughness = 0.2; baseMaterial.clearcoat = 0.3; label.innerText = "Standard PLA"; } 
            else { bg.style.transform = 'translateX(100%)'; btns[0].style.color = '#fff'; btns[1].style.color = '#000'; baseMaterial.roughness = 0.5; baseMaterial.clearcoat = 0.0; label.innerText = "Tough PLA+"; }
        };

        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
        animate();

        window.addEventListener('resize', () => {
            const isMobile = window.innerWidth < 768; camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.position.z = isMobile ? 15 : 10;
        });
    </script>
</body>
</html>